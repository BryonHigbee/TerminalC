<!DOCTYPE html>
<head>
    <title>TerminalC Executor</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..200,0..1,-50..100" />
    <link rel="stylesheet" href="externa/style.css">
    <style>
        /* Your existing styles are fine */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }
        .execution {
            display: flex;
            flex-direction: column; /* Stack items vertically */
            justify-content: center;
            align-items: center;
            height: calc(100vh - 70px);
            padding: 20px;
        }
        #scriptOutput {
            width: 80%;
            height: 300px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            color: #d0d0d0;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            resize: vertical;
        }
        .status-bar {
            margin-top: 15px;
            font-size: 1rem;
            color: #888;
        }
        .status-connected { color: #4caf50; font-weight: bold; }
        .status-disconnected { color: #f44336; font-weight: bold; }

        /* Modified input fields */
        .settings input[type="text"] {
            background-color: #2c2c2c;
            color: white;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            width: calc(100% - 22px); /* Account for padding */
        }
        .settings input#Username {
            background-color: #222; /* Darker for readonly */
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <nav class="topbar">
        <img src="externa/imagen/vision-logo.png" class="logo-elemen">
        <div class="centro">
             <div class="TopBarButton">
                 <span class="material-symbols-outlined" >deployed_code</span>
                 <p>Executor</p>
             </div>
             <div class="TopBarButton" style="color: rgb(81, 81, 81);" onclick="document.getElementById('settings_box').style.display = 'flex';">
                 <span class="material-symbols-outlined">settings</span>
                 <p>Settings</p>
             </div>
             <div class="TopBarButton" style="color: rgb(81, 81, 81);">
                 <span class="material-symbols-outlined">open_in_new</span>
                 <p>Open Roblox</p>
             </div>
        </div>
    </nav>
    
    <div class="execution" id="execu">
        <textarea id="scriptOutput" readonly>Enter your key in Settings and connect to start receiving scripts.</textarea>
        <div id="statusBar" class="status-bar">Status: <span class="status-disconnected">Disconnected</span></div>
    </div>

    <div class="settings" style="display: none;" id="settings_box">
        <div class="TitleBarSettings">
            <h1 class="sts">Settings</h1>
            <button class="x_button" onclick="document.getElementById('settings_box').style.display = 'none'">X</button>
        </div>
        <input type="text" id="KeyBox" placeholder="Enter your key here...">
        <input type="text" id="Username" value="N/A" readonly>
    </div>

<script>
    const keyBox = document.getElementById('KeyBox');
    const usernameBox = document.getElementById('Username');
    const scriptOutput = document.getElementById('scriptOutput');
    const statusBar = document.getElementById('statusBar');

    // --- CONFIGURATION ---
    const SERVER_URL = 'http://localhost:8080'; // Change to your server's URL if deployed
    let scriptPoller = null; // This will hold our setInterval ID
    let userKey = '';

    // Function to update the connection status display
    function updateStatus(isConnected, username = '') {
        const statusSpan = statusBar.querySelector('span');
        if (isConnected) {
            statusSpan.textContent = `Connected as ${username}`;
            statusSpan.className = 'status-connected';
            scriptOutput.value = 'âœ… Connected! Waiting for a script to be sent from the batch file...';
        } else {
            statusSpan.textContent = 'Disconnected';
            statusSpan.className = 'status-disconnected';
            scriptOutput.value = 'Connection failed or key not found. Please check your key and ensure the batch file has been authenticated once.';
        }
    }

    // This function will run on an interval to check for new scripts
    async function pollForScript() {
        if (!userKey) return;
        try {
            const response = await fetch(`${SERVER_URL}/key/${userKey}`);
            const data = await response.json();
            
            // Display script only if it's not the default "no script" message
            if (data.script && data.script !== '-- No new script to execute. --') {
                scriptOutput.value = data.script;
                console.log('Script received:', data.script);
            }
        } catch (error) {
            console.error('Error polling for script:', error);
            // Optional: Stop polling on error
            // clearInterval(scriptPoller);
            // updateStatus(false);
        }
    }

    // Event listener for when the user enters a key in the settings panel
    keyBox.addEventListener('change', async () => {
        const key = keyBox.value.trim();
        if (!key) return;

        // Stop any previous polling
        if (scriptPoller) clearInterval(scriptPoller);

        try {
            // 1. Contact the server to get the username for the entered key
            const response = await fetch(`${SERVER_URL}/user/${key}`);
            if (!response.ok) {
                throw new Error('Key not found or user not registered.');
            }
            const data = await response.json();
            const username = data.username;
            
            // 2. Update UI and start polling
            userKey = key; // Store the validated key
            usernameBox.value = username;
            updateStatus(true, username);
            
            // Start polling for scripts every 3 seconds (3000 milliseconds)
            scriptPoller = setInterval(pollForScript, 3000);

        } catch (error) {
            console.error('Failed to connect:', error);
            usernameBox.value = 'N/A';
            userKey = '';
            updateStatus(false);
        }
    });

</script>   
</body>
</html>
